@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutMap.cshtml";
}
<style type="text/css">
    .map-container {
        position: relative;
        width: 100%;
        height: 100%;
    }


    .map-header {
        height: 90px;
        width: 100%;
    }

    .map-header-container {
        position: relative;
    }

    .map-logo {
        width: 195px;
        height: 62px;
        background: url(/content/images/logo.png) 0 0 no-repeat;
        outline: 0;
        position: absolute;
        top: 10px;
        overflow: hidden;
        left: 20px;
    }

        .map-logo a {
            display: block;
            width: 195px;
            height: 62px;
            overflow: hidden;
            text-indent: -99999px;
        }

    .map-search {
        color: #333;
        padding: 4px 0 0 45px;
        background: url(/content/images/indexSprite.png) 0 -45px no-repeat;
        width: 407px;
        height: 44px;
        position: absolute;
        top: 17px;
        z-index: 83;
        left: 260px;
    }

        .map-search .search-text {
            background-image: none;
            width: 321px;
            height: 36px;
            line-height: 38px 9;
            outline: 0;
            color: #999;
            border: 0;
        }

        .map-search .search-button {
            border: 0;
            background: url(/content/images/indexSprite.png) no-repeat;
            background-position: -400px 0;
            width: 81px;
            margin: 0 0 0 1px;
            height: 40px;
            line-height: 0;
            font-size: 0;
            -webkit-text-size-adjust: none;
            cursor: pointer;
        }

    .map-content {
        position: absolute;
        top: 90px;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .map-left {
        width: 400px;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 10;
    }

    .map-filter {
        background: url(http://pages.anjukestatic.com/img/map/newmap2-marker-bgs.gif) repeat-x 0 0;
        width: 378px;
        height: 26px;
        line-height: 26px;
        border: 1px solid #DCDBDB;
        padding-left: 20px;
        position: relative;
        z-index: 9;
    }

    a.map-filter-btn {
        margin-left: 13px;
        background: url(http://pages.anjukestatic.com/img/map/newmap2-top-arrow2.gif) no-repeat right -24px;
        padding-right: 12px;
        display: inline-block;
        line-height: 26px;
        color: #0041D9;
    }

    .map-control {
        position: absolute;
        left: 400px;
        top: 0px;
        right: 0px;
        bottom: 0px;
        z-index: 1;
        overflow: hidden;
        zoom: 1;
        border-top: 1px solid #DCDBDB;
        border-left: 1px solid #DCDBDB;
    }

    .map-list {
        overflow-y: auto;
        position: absolute;
        top: 26px;
        right: 0px;
        bottom: 0px;
        left: 0px;
    }

    .map-filter-selectbox {
        display: none;
    }

    .map-list-item-hover {
        background: #f2d7d7;
        cursor: pointer;
    }


    .map-loadding {
        display: none;
    }
</style>
<div class="map-container">
    <div class="map-header">
        <div class="map-header-container">
            <div class="map-logo">
                <a href="/" title="">广知网</a>
            </div>
            <div class="map-search">
                <input class="search-text" id="search-text" type="text" value="三面翻">
                <input class="search-button" id="search-button" type="button" value="">
                <ul class="top-head-suggest" style="display: none;"></ul>
            </div>
        </div>
    </div>
    <div class="map-content">
        <div class="map-left">
            <div class="map-filter">
                <span>筛选条件：<span id="map-filter-condition">媒体类型不限，价格不限</span></span>
                <a href="javascript:void(0)" class="map-filter-btn">更改</a>
                <div class="map-filter-selectbox">
                    <dl class="clearfix">
                        <dt class="price-icon">售价</dt>
                        <dd id="filter-price-boxer">
                            <span id="l_priceLi_0"><a href="javascript:void(0)" paramid="0" class="select-on">不限</a></span>
                            <span id="l_priceLi_2"><a href="javascript:;" paramid="2">50万以下</a></span>
                            <span id="l_priceLi_3"><a href="javascript:;" paramid="3">50-80万</a></span>
                            <span id="l_priceLi_4"><a href="javascript:;" paramid="4">80-100万</a></span>
                            <span id="l_priceLi_5"><a href="javascript:;" paramid="5">100-120万</a></span>
                            <span id="l_priceLi_6"><a href="javascript:;" paramid="6">120-150万</a></span>
                            <span id="l_priceLi_7"><a href="javascript:;" paramid="7" class="">150-200万</a></span>
                            <span id="l_priceLi_8"><a href="javascript:;" paramid="8">200-250万</a></span>
                            <span id="l_priceLi_9"><a href="javascript:;" paramid="9">250-300万</a></span>
                            <span id="l_priceLi_10"><a href="javascript:;" paramid="10">300-500万</a></span>
                            <span id="l_priceLi_11"><a href="javascript:;" paramid="11">500-1000万</a></span>
                            <span id="l_priceLi_12"><a href="javascript:;" paramid="12">1000万以上</a></span>
                        </dd>

                        <dt class="area-icon">面积</dt>
                        <dd id="filter-range-boxer">
                            <span id="l_rangeLi_0"><a href="javascript:void(0)" paramid="0">不限</a></span>
                            <span id="l_rangeLi_2"><a href="javascript:;" paramid="2" class="select-on">50平米以下</a></span>
                            <span id="l_rangeLi_3"><a href="javascript:;" paramid="3">50-70平米</a></span>
                            <span id="l_rangeLi_4"><a href="javascript:;" paramid="4">70-90平米</a></span>
                            <span id="l_rangeLi_5"><a href="javascript:;" paramid="5">90-110平米</a></span>
                            <span id="l_rangeLi_6"><a href="javascript:;" paramid="6">110-130平米</a></span>
                            <span id="l_rangeLi_7"><a href="javascript:;" paramid="7">130-150平米</a></span>
                            <span id="l_rangeLi_8"><a href="javascript:;" paramid="8">150-200平米</a></span>
                            <span id="l_rangeLi_9"><a href="javascript:;" paramid="9">200-300平米</a></span>
                            <span id="l_rangeLi_10"><a href="javascript:;" paramid="10">300-500平米</a></span>
                            <span id="l_rangeLi_11"><a href="javascript:;" paramid="11">500平米以上</a></span>
                        </dd>

                        <dt class="model-icon">房型</dt>
                        <dd class="model-list" id="filter-model-boxer">
                            <span id="l_modelLi_0"><a href="javascript:void(0)" paramid="0" class="select-on">不限</a></span>
                            <span id="l_modelLi_2"><a href="javascript:;" paramid="2">一室</a></span>
                            <span id="l_modelLi_4"><a href="javascript:;" paramid="4">二室</a></span>
                            <span id="l_modelLi_10"><a href="javascript:;" paramid="10">三室</a></span>
                            <span id="l_modelLi_11"><a href="javascript:;" paramid="11">四室</a></span>
                            <span id="l_modelLi_12"><a href="javascript:;" paramid="12">五室</a></span>
                            <span id="l_modelLi_13"><a href="javascript:;" paramid="13">五室以上</a></span>
                        </dd>
                    </dl>
                    <div class="select-btm" id="btn-hide-fiter-box"><a href="javascript:void(0)" id="" class="close-list">收起选择</a></div>
                </div>
            </div>
            <div class="map-list gray-list">
            </div>
        </div>
        <div class="map-control" id="map-control"></div>
    </div>
    <div class="gary-loadding map-loadding">
        <img src="@Url.Content("~/Content/images/loading.gif")" />
    </div>
</div>

@section scripts{
    <script type="text/javascript">
        var MapSearch = {
            init: function() {
                var self = this;
                self.map = new BMap.Map("map-control");            // 创建Map实例
                self.map.centerAndZoom("@UIHelper.GetCityName()", 15);
                self.map.addControl(new BMap.NavigationControl());               // 添加平移缩放控件
                self.map.addControl(new BMap.ScaleControl());                    // 添加比例尺控件
                self.map.addControl(new BMap.OverviewMapControl());
                self.map.enableScrollWheelZoom();
                self.map.addEventListener("dblclick", function() {
                    self.searchArea();
                });
                self.map.addEventListener("rightdblclick", function() {
                    self.searchArea();
                });
                self.map.addEventListener("zoomend", function() {
                    self.searchArea();
                });
                self.map.addEventListener("dragend", function() {
                    self.searchArea();
                });

            },
            load: function(path, callback) {
                var script = document.createElement("script");
                script.src = "http://api.map.baidu.com/api?v=1.3&callback=MapSearch.init";
                document.body.appendChild(script);
            },
            searchArea: function() {
                var self = this,
                    areas = self.getSearchArea();
                self.showBusy();
                self.getSearchResult(areas).done(function(data) {
                    self.renderList(data);
                    self.renderMarker(data);
                })
            },

            showBusy: function() {
                $('.map-list').empty();
                var loading = $('.gary-loadding').clone();
                $('.map-list').append(loading);
                loading.show();
            },

            getSearchResult: function(opts) {
                var d = $.Deferred();
                $.ajax({
                    type: "GET",
                    url: "@Url.Action("getsearcharea", "ajaxcontent")",
                    data: opts,
                    success: function(res) {
                        d.resolve(res);
                    }
                });
                return d.promise();
            },

            getSearchArea: function() {
                var self = this,
                    bs = self.map.getBounds();

                return {
                    minX: bs._swLat,
                    minY: bs._swLng,
                    maxX: bs._neLat,
                    maxY: bs._neLng
                };
            },
            renderList: function(data) {
                var html = '<ul>',
                    showUrl = 'media',
                    items = data.Items;
                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    var itemHtml = '<li class="clearfix map-list-item"  data-id="' + item.ID + '" >'
                         + '<a href="' + showUrl + '-' + item.ID + '" target="_blank" >'
                         + '    <img src="' + item.ImgUrl + '" alt="' + item.Name + '" /></a>'
                         + '<p class="item-desc">'
                         + '    <a target="_blank" title="' + item.Name + '" href="' + showUrl + '-' + item.ID + '">' + item.Name + '</a>'
                         + '</p>'
                         + '<p class="item-category" >' + item.ProvinceName + '-' + item.CityName + '</p>'
                         + '<p class="item-price c_red"><strong>¥' + item.Price + '</strong> 万元/年</p>';

                    html += itemHtml;
                }
                html += '</ul>';
                $('.map-list').html(html);

                $('.map-list-item').on('mouseenter', function() {
                    $(this).addClass('map-list-item-hover');
                    var Infowindow = $(this).data('window');
                    var marker = $(this).data('marker');
                    marker.openInfoWindow(Infowindow);
                }).on('mouseleave', function() {
                    $(this).removeClass('map-list-item-hover');
                    var marker = $(this).data('marker');
                    marker.closeInfoWindow();
                })

            },

            renderPage: function(data) {

            },

            renderMarker: function(data) {
                var self = this,
                    items = data.Items;
                self.map.clearOverlays();
                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    self.addMarker(item);
                }
            },
            addMarker: function(item) {

                var self = this;

                var iconUrl = '@Url.Content("~/Content/images/mapmarker.png")';

                var myIcon = new BMap.Icon(iconUrl, new BMap.Size(29, 35), {

                    offset: new BMap.Size(10, 15),

                    imageOffset: new BMap.Size(0, -209)

                });

                var point = new BMap.Point(item.Lng, item.Lat);

                var marker = new BMap.Marker(point, { icon: myIcon });

                self.map.addOverlay(marker);

                marker.enableDragging();

                var infoOpts = {

                };

                infoOpts.title = "<a target='_blank' data-windowId='" + item.ID + "' href='media-" + item.ID + "' style='margin-left:3px;' >" + item.Name + "</a>";

                var imgurl = "<a target='_blank' href='media-" + item.ID + "'  style=' margin-top:5px;' ><img src='" + item.ImgUrl + "' style='width:100%;' /></a><div style=' margin-top:5px;text-align:right;'>价格:<strong class='c_red'>" + item.Price + "</strong> 万元/年 </div>";



                var content = '<div style="margin:0;line-height:20px;padding:2px;width:350px;">' +

                    '<img src="' + item.ImgUrl + '" alt="" style="float:right;zoom:1;overflow:hidden;width:100px;height:100px;margin-left:3px;"/>' +

                    '公司：<a target="_blank" href="biz/' + item.MemberID + '">' + item.CompanyName + '</a><br/>媒体描述：' + (item.Description.length > 50 ? item.Description.substr(0, 50) + '...' : item.Description) + '<br/>' +

                    '价格：<strong class="c_red">' + item.Price + '</strong> 万元/年' +

                    '</div>';

                var infoWindow = new BMap.InfoWindow(content, infoOpts);  // 创建信息窗口对象   

                var li = $('[data-id="' + item.ID + '"]');

                li.data('window', infoWindow);

                li.data('marker', marker);

                marker.addEventListener("mouseover", function() {

                    this.openInfoWindow(infoWindow);      // 打开信息窗口 

                })

                return marker;
            }
        }

        $(function() {
            MapSearch.load();
        })

    </script>

}